import { Agent, ClientRequest, RequestOptions } from 'http';

type AgentCallbackCallback = (err: Error | null | undefined, rtn?: AgentCallbackReturn) => void;
type AgentCallbackReturn = unknown;
type AgentCallbackPromise = (req: ClientRequest, opts: RequestOptions) => Promise<AgentCallbackReturn>;

type LegacyCallback = (
	req: ClientRequest,
	opts: RequestOptions,
	fn: AgentCallbackCallback
) => void;

export default function promisify(fn: LegacyCallback): AgentCallbackPromise {
	return function(this: Agent, req: ClientRequest, opts: RequestOptions) {
		return new Promise((resolve, reject) => {
			fn.call(
				this,
				req,
				opts,
				(err: Error | null | undefined, rtn?: AgentCallbackReturn) => {
					if (err) {
						reject(err);
					} else {
						resolve(rtn);
					}
				}
			);
		});
	};
}
